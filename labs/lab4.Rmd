---
title: 'POLS 503: Lab 4'
author: "Sergio Garcia-Rios"
date: "April 24, 2015"
output:
  html_document:
    highlight: default
---

This lab will use some libraries you've seen before
```{r, echo=FALSE, messages=FALSE, alerts=FALSE}
library("foreign")
library("dplyr")
library("ggplot2")
```
Also, some that may be new to you
```{r message = FALSE}
library("broom")
library("stargazer")
library("coefplot")
```


## Data

Download and and read in the Ross data
```{r}
rossdata <- read.csv("http://pols503.github.io/pols_503_sp15/data/ross_2012.csv",
                     stringsAsFactors = FALSE)
```

This is a pretty big data set, we do not need all the variables let subset our data to include only the variables we will use.

Create a new data set containing only  `cty`, `year`, `polity`, `logoil_gdpcap2000_sup_Q_1`, `logGDPcap`, `oecd`:
 
```{r}
dim(rossdata)
```
 
```{r results='hide'}
head(rossdata)
glimpse(rossdata)
```


```{r}
rossdata2 <- rossdata %>% 
  tbl_df() %>% 
  select(cty, year, polity, logoil_gdpcap2000_sup_Q_1, logGDPcap, oecd) %>%
  rename(oil = logoil_gdpcap2000_sup_Q_1, gdp = logGDPcap)
```



```{r}
glimpse(rossdata2)
rossdata2
rossdata2 <- na.omit(rossdata2)
```


```{r}
rossdata2 %>%
  summary()
```



```{r}
ggplot(rossdata2, aes(x = gdp, y = polity, colour = oil, shape=factor(oecd))) +
  geom_point(position = position_jitter(height = .5),  size = 3) + 
  theme_bw() 
```



```{r}
ggplot(rossdata2, aes(x = gdp, y = polity, colour = factor(oecd))) +
  geom_point(aes(size=(oil)),position = position_jitter(height = .5)) + 
  theme_bw() 
```



<div class="panel">
5. What is the average level of democracy for observations where oil exports make up less than 10 percent of GDP?
6. What is the average level of democracy among the top twenty percent of oil exporting countries in the year 1995?
    What is the average among the bottom eighty percent?

7. What is the difference between the average level of democracy among countries with GDP per capita of less than 
    $10,000 and the average level among countries with greater than or equal to $10,000, for the year 1980? What is
    this difference for 1990?
8. Make an interesting scatterplot.
</div>

## 3. Modeling and Plotting Example 2 -- see Lab 2 for Example 1! 

```{r}

model1 <- lm(polity ~ gdp, data=rossdata2)
summary(model1)
```


```{r}
model2 <- lm(polity ~ gdp + oil + oecd, data=rossdata2)
summary(model2)
```

- Which has a larger impact on the level of democracy: oil dependence or OECD membership?
- Which has a larger impact on the level of democracy: oil dependence or GDP per capita?

```{r}
model3 <- lm(polity ~ gdp + oil * oecd, data = rossdata2)
summary(model3)
```

How would you interpret these results?

**SIDE NOTE**: if you don't like the displays to use scientific notation (such as 1.846e-04):
options(scipen=10)

Suppose we want to calculate the predicted level of democracy for a country with GDP per capita of $5,000, no oil exports, and in the OECD:


```{r}
glance(model2)
tidy(model2)
```


```{r}
head(augment(model2))

ggplot(tidy(model2) %>% filter(term != "(Intercept)"), 
       aes(x = term, y = estimate, 
           ymin = estimate - 2 * std.error, 
           ymax = estimate + 2 * std.error)) + 
  geom_pointrange() + 
  coord_flip()

```


```{r}
coefplot(model2)
```

Since `coefplot` uses **ggplot2** to create its plots, it returns a `ggplot` object,
which can be added to with other **ggplot2** functions
```{r}
coefplot(model2, coefficients = c("oecd", "oil", "gdp")) +
  theme_bw()
```


Look at the help for coefplot
```{r eval = FALSE}
?coefplot
```

```{r}
stargazer(model1, model2, model3, type = "text")
```


```{r}
yhat <- predict(model1, interval = "confidence")
yhat_df <- as.data.frame(yhat) %>%
  add_rownames(var = "occupation")
head(yhat_df)
```



```{r}
xnew <- data.frame(gdp = 5.9, oil = 0, oecd = 1)
predict(model2, newdata=xnew, interval="confidence")
```


```{r}
xnew <- list(gdp = 5.9, oil = 0, oecd = 0)
predict(model2, newdata = xnew, interval = "confidence")
```



What is this really doing?
```{r}
pe2 <- model2$coefficients
1 * pe2[1] + 5000 * pe2[2] + 0 * pe2[3] + 1 * pe2[4]
```

same as the predicted value above. predict() applies the coefficients estimated by our model to hypothetical values of the independent variables. 

Now what does our model predict for a country with GDP per capita of $10,000?

```{r}
xnew <- data.frame(gdp = 10000, oil = 0, oecd = 1)
predict(model2, newdata = xnew, interval="confidence")
```


We can create a matrix of hypothetical data to obtain predictions for a range of values:

create a vector of hypothetical values of GDP per capita

```{r}
gdp_hyp <- seq(4, 11, by = 1)
```


create a matrix containing all hypothetical values, which are constant for the other covariates:

```{r}
xnew <- data.frame(gdp = gdp_hyp,
                   oil = rep(0, length(gdp_hyp)),
                   oecd = rep(1, length(gdp_hyp)))
xnew

```


What does this object mean?


```{r}
pred.res<-predict(model2, newdata=xnew, interval="confidence")
pred.res
```


```{r}
mod2_predicted<-as.data.frame(pred.res)
mod2_pred_df <- cbind(xnew, mod2_predicted)
```




```{r}
ggplot() +
  geom_line(data = mod2_pred_df, mapping = aes(x = gdp, y = fit)) +
  geom_ribbon(data = mod2_pred_df, mapping = aes(x = gdp, ymin = lwr, ymax = upr),
              alpha = 0.2)+
  ylab("prestige")+
  theme_bw()
```


Using prediction and plotting to interpret interaction terms:

We will use the results of model 3 above:

```{r}
summary(model3)
```


```{r}
oil_hyp <- seq(0,11,by=1)

xnew1 <- list(oil = oil_hyp, gdp=rep(mean(rossdata2$gdp), length(oil_hyp)),
              oecd=rep(0, length(oil_hyp)))
xnew1

pred.res1 <- predict(model3, newdata=xnew1, interval="confidence")
pred.res1
```



Now repeat with oecd=1
```{r}
xnew2 <- data.frame(oil = oil_hyp, gdp = rep(mean(rossdata2$gdp), length(oil_hyp)),
                    oecd=rep(1, length(oil_hyp)))
xnew2
```



Make sure to name this object something different from the previous one; we need both to compare!

```{r}
pred.res2<-predict(model3, newdata=xnew2, interval="confidence")

mod3_predicted_1<-as.data.frame(pred.res1)
mod3_pred_df_1 <- cbind(xnew1, mod3_predicted_1)

mod3_predicted_2<-as.data.frame(pred.res2)
mod3_pred_df_2 <- cbind(xnew2, mod3_predicted_2)

mod3_pred_df<-bind_rows(mod3_pred_df_1,mod3_pred_df_2)
```



```{r}

ggplot(mod3_pred_df, aes(x =oil , y = fit, 
                         ymin = lwr, ymax = upr)) +
  geom_line(mapping = aes(colour = factor(oecd))) +
  geom_ribbon(mapping = aes(fill = factor(oecd)), alpha = 0.2) +
  ylab("Democracy") + 
  ggtitle("Predicted values of prestige by type, holding education constant")+
  theme_bw()
```

* * *

<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
R code is licensed under a [BSD 2-clause](http://www.r-project.org/Licenses/BSD_2_clause) license.


