---
title: 'Lab 2: Graphing and Data Manipulation'
author: "Jeffrey B. Arnold and Sergio Garcia-Rios"
date: "April 10, 2015"
output: html_document
---

## Objectives

1. Use `dplyr` to manipulate data
2. Understand what a tidy dataset is and how to get data into

#  Meet the mighty `dplyr`
Dplyr aims to provide a function for each basic verb of data manipulating:

-  `filter()` (and `slice()`)
-  `arrange()`
-  `select()` (and `rename()`)
-  `distinct()`
-  `mutate()` (and `transmute()`)
-  `summarise()`
-  `sample_n()` and `sample_frac()`



***
***
## Load Relevant Libraries

The main  objective is to get you familirized with `dplyer` and `ggplot2` so make sure to install and load those libraries

```{r, Libraries, warning=FALSE,message=FALSE}
library(dplyr)
library(ggplot2)
```


## Load the Data

We are going to be using the gapminder data again.


```{r}
gd_url <- "http://tiny.cc/gapminder"
gdf <- read.delim(file = gd_url)
```

Let's take a look at the structure of this dataset using ``str{}`` which gives us usefull information about the internal structure of any ``R`` object. 
```{r}
str(gdf)
```

We have previously used ``head()`` which is useful to get a quick view of your data but this time we are trying something different.

We are going to use `tbl_df()` which is a wrapper around a data frame that won’t accidentally print a lot of data to the screen 

```{r}
gtbl <- tbl_df(gdf)
gtbl
```

A `tbl_df` is basically an improved data.frame, for which dplyr provides nice methods for high-level inspection.

***

We can also use `glimse`
```{r}
glimpse(gtbl)
```

## Exploring our Data

We are ready to begin exploring our data set in more depth.

We want to explore the relarionship between life expecrtancy and gdp. Let's use some `dplyr` verbs to explore our data. For you STATA users missing "if statements" let's begin with `filter()` 

```{r}
filter(gtbl, lifeExp < 29)
filter(gtbl, country == "Rwanda")
filter(gtbl, country %in% c("Rwanda", "Afghanistan"))
```



## Meet the new pipe operator

Before we go any further, we should exploit the new pipe operator that `dplyr` imports from the magrittr package. This is going to change your data analytical life.

Here’s what it looks like: `%>%`
```{r}
gdf %>% head()

```

This is equivalent to head(gdf). This pipe operator takes the thing on the left-hand-side and pipes it into the function call on the right-hand-side – literall, drops it in as the first argument.

Of course, you can still specify other arguments to this function! To see the first 3 rows of Gapminder, we could say:
```{r}
gdf %>% head(3)
```

# Use filter() to subset data row-wise.
filter() takes logical expressions and returns the rows for which all are TRUE.

```{r}
filter(gtbl, lifeExp>40) %>%
  head(3)
```



## Use `select()` to subset the data on variables or columns.

Most of the times we don't need to see al the variables and are often interested in just a few of them. Here’s a conventional call:
```{r}
select(gtbl, year, lifeExp) ## tbl_df prevents TMI from printing
```

#Challenge

Using a combination of `filter`, `select` and and `head` show only year and life expectancy of Cambodia.for the first two observations


```{r}
gtbl %>%
  filter(country == "Cambodia") %>%
  select(year, lifeExp) %>%
  head(2)
```


# Use `mutate()` to add (generate?) new variables



Imagine we wanted to recover each country’s GDP. We do have data for population and GDP per capita. what do we do?

-  Yes we multiply, let's create a new variable called gdp that brings back the gross amount

```{r}

gtbl <- gtbl %>%
mutate(gdp = pop * gdpPercap)


gtbl %>% glimpse #let's take a look

```

###############

So... GDP is almost uselless becuase it doesn't give a base line and that is why we often use per capita, but a baseline is often more useful, how about comparing it to anohter country sat, USA? Yes USA, USA, USA!

Let's  create first an obkect containing only US data, we use `filter' here
```{r}
just_usa <- gtbl %>% filter(country == "United States")

```

Remember our frine `match` from that 501 R homework, Yeah I don't remeber either... Well, here it is again!
```{r}
gtbl <- gtbl %>%
  mutate(usa = just_usa$gdpPercap[match(year, just_usa$year)],
         gdpPercapRel = gdpPercap / usa)

gtbl


gtbl %>%
  select(gdpPercapRel) %>%
  summary
```

Nice, now we can do something like this:

Look at the GDP per capita  of Mexico and Canda realtive to US by year
```{r}
gtbl %>%filter(country==c("United States", "Canada", "Mexico")) %>%
  select(country, year, gdpPercap, usa, gdpPercapRel)
```

Great! Mexico is way poorer in relation to US. 



## `arrange` becuase the world is not always ordered the way we want it
```{r}
gtbl %>%
  arrange(year, country)


gtbl %>%
  filter(year == 2007) %>%
  arrange(lifeExp)

```


## Challenge


What about life expectancy? Create a relative to life expectancy variable, compare the three NAFTA countries US, Canada and Mexico 


```{r}
# Challenge here
```


WOW! Mexicans are relatively poor but not dying, Great!

***
***
***

# Now `ggplot2`

 -->
The most important ggplot2 components are:  `geoms`, `aesthetic`, `mappings` and `faceting`.

   * Aesthetic attributes, aes for short: like colour, size and shape,
   * Geometric objects, geoms for short, represent what you actually see on the plot: points, lines, polygons, etc.
   * Statistical transformations, stats for short, summarise data in many useful ways.



Let's continue using the gapminder data, take another look at it

```{r}
glimpse(gtbl)
```

Great, let the ggploting begin:

```{r}
 # ggplot(gtbl, aes(x = gdpPercap, y = lifeExp)) 
```
Nothing to plot yet! This just initializes the gg, it is better if you assing it to an object, `p` is good enough 
```{r}
p <- ggplot(gtbl, aes(x = gdpPercap, y = lifeExp))
```
  
No we can add `geoms` 
```{r}
p + geom_point()
```


That look Okay but it would probably look be better if we  log transform 
```{r}
p_l<-ggplot(gtbl, aes(x = log10(gdpPercap), y = lifeExp)) 

p_l+geom_point()
```

A better way to log transform
```{r}

p + geom_point() + scale_x_log10()

```

Let's make that stick
```{r}
p <- p + scale_x_log10()

```
Common workflow: gradually build up the plot you want,  re-define the object 'p' as you develop "keeper" commands. Note that in the rea-assigning we excluded the `geom`  


Now, let's MAP continent variable to aesthetic color

```{r}


p + geom_point(aes(color = continent))

```
In full detail, up to now:
```{r}
ggplot(gtbl, aes(x = gdpPercap, y = lifeExp, color = continent)) +
  geom_point() + scale_x_log10() 
```

Let's address overplotting: SET alpha transparency and size to a value
```{r}
p + geom_point(alpha = (1/3), size = 3)

```

Add now a fitted curve or line
```{r}
p + geom_point() + geom_smooth()
p + geom_point() + geom_smooth(lwd = 2, se = FALSE)

p +  geom_smooth(lwd = 1, se = FALSE, method = "lm") + geom_point()

``` 
That's great but i actuly think want revive our interest in continents!
```{r}

p + aes(color = continent) + geom_point() + geom_smooth(lwd = 3, se = FALSE)
```
Facetting: another way to exploit a factor
```{r}
p + geom_point(alpha = (1/3), size = 3) + facet_wrap(~ continent)

# Still want lines? Let's add them
p + geom_point(alpha = (1/3), size = 3) + facet_wrap(~ continent) +
  geom_smooth(lwd = 2, se = FALSE)
```

## Challenge:  

* plot lifeExp against year  
* make mini-plots, split out by continent  
* add a fitted smooth and/or linear regression, w/ or w/o facetting  



```{r}
## CHALLENGE HERE


# plot lifeExp against year
# y <- ggplot(gDat, aes(x = year, y = lifeExp)) + geom_point()

# make mini-plots, split out by continent
# y + facet_wrap(~ continent)

# add a fitted smooth and/or linear regression, w/ or w/o facetting
#y + geom_smooth(se = FALSE, lwd = 2) +
#  geom_smooth(se = FALSE, method ="lm", color = "orange", lwd = 2)

# y + geom_smooth(se = FALSE, lwd = 2) +
#  facet_wrap(~ continent)

```

What if I am only interrested in the US?

sadly, ggplot() does not have a 'subset =' argument  
so do that 'on the fly' with subset(..., subset = ...)

```{r}
ggplot(subset(gtbl, country == "United States"),
       aes(x = year, y = lifeExp)) + geom_line() + geom_point()

```

Let just look at five countries

```{r}
jCountries <- c("United States", "Canada", "Rwanda", "Cambodia", "Mexico")
ggplot(subset(gtbl, country %in% jCountries),
       aes(x = year, y = lifeExp, color = country)) + geom_line() + geom_point()
``` 


So what's up with Mexico?

* Nafta? Higher GDP?

Not really...
```{r}
jCountries <- c("United States", "Canada", "Rwanda", "Cambodia", "Mexico")
ggplot(subset(gtbl, country %in% jCountries),
       aes(x = year, y = lifeExp, color = country)) + geom_line() + geom_point(aes(size=gdpPercap))
``` 


## References

- Hadley Wickham's tutorials from useR 2014: Video [Part I](https://www.youtube.com/watch?v=8SGif63VW6E), [Part II](https://www.youtube.com/watch?v=Ue08LVuk790), [Slides and Tutorial](https://www.dropbox.com/sh/i8qnluwmuieicxc/AAAgt9tIKoIm7WZKIyK25lh6a).
- [Data Carpentry](http://datacarpentry.org/) [https://github.com/datacarpentry/datacarpentry/tree/master/lessons/tidy-data](tidy data) lesson

- The vignette for dplyr and tidyr are good: http://cran.rstudio.com/web/packages/dplyr/vignettes/introduction.html

