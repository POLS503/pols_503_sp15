---
title: Lab 6 - More Regression Interpretation
author: Carolina Johnson, Jeffrey Arnold
date: Friday May 8, 2015
---

```{r, results = 'hide', echo = FALSE}
knitr::opts_chunk$set(tidy = TRUE,
                      tidy.opts = list(width.cutoff = 60, indent = 2))
```

As always, start the lab by loading the packages we will be using.

```{r, message=FALSE, warning=FALSE}
library(MASS)
library(dplyr)
library(ggplot2)
library(broom)
```




## More on Interpretation

Once more we'll use data from Ross on oil, this time from the earlier 2001 paper.
```{r, results='hide'}
rossdata_url <- "http://staff.washington.edu/csjohns/503/rossoildata.csv"
rossdata_raw <- read.csv(rossdata_url, stringsAsFactors = FALSE)
rossdata <- rossdata_raw %>%
  select(cty_name, year, regime1, oil, GDPcap, oecd) %>%
  na.omit()

```

Let's run the standard model from Ross for the relationship between oil and GDP.
```{r}
model1 <- lm(regime1 ~ GDPcap + oil + oecd + year, data = rossdata)
summary(model1)
```

Now predict the expected value of regime type vs. oil:
```{r}
pred1_df <- data.frame(oil = seq(0, 100, by = 10),
                       GDPcap = mean(rossdata$GDPcap), 
                       oecd = 0,
                       year = median(rossdata$year))
pred1 <- predict(model1, newdata = pred1_df, interval = "confidence")

ggplot(bind_cols(pred1_df, as.data.frame(pred1)),
       aes(x = oil, y = fit, ymin = lwr, ymax = upr)) + 
  geom_ribbon(alpha = 0.2) +
  geom_line()
```

This is easiest to plot with `augment` instead
```{r}
pred1_aug <- augment(model1, newdata = pred1_df)
ggplot(pred1_aug, aes(x = oil, y = .fitted,
                      ymin = .fitted + 2 * .se.fit,
                      ymax = .fitted - 2 * .se.fit)) + 
  geom_ribbon(alpha = 0.2) +
  geom_line()
```

**Challenge:** Do this with both OECD and non-OECD countries. Before plotting, 
how will these differ? 

**Answer:**
```{r}
pred2_df <- expand.grid(oil = seq(0, 100, by = 10),
                        GDPcap = mean(rossdata$GDPcap), 
                        oecd = c(0, 1),
                        year = median(rossdata$year))
pred2 <- predict(model1, newdata = pred2_df, interval = "confidence")
ggplot(bind_cols(pred2_df, as.data.frame(pred2)),
       aes(x = oil, y = fit, ymin = lwr, ymax = upr,
           colour = factor(oecd), fill = factor(oecd))) + 
  geom_ribbon(alpha = 0.2, colour = NA) +
  geom_line()
```

This is easiest to plot with `augment` instead
```{r}
pred1_aug <- augment(model1, newdata = pred2_df)
ggplot(pred1_aug, aes(x = oil, y = .fitted,
                      ymin = .fitted + 2 * .se.fit,
                      ymax = .fitted - 2 * .se.fit,
                      fill = factor(oecd), colour = factor(oecd))) + 
  geom_ribbon(alpha = 0.2, colour = NA) +
  geom_line()
```

**Challenge:** Does it make sense to plot oil from 0 to 100? Check the range of oil?

Surprisingly, not that bad.
```{r}
ggplot(rossdata, aes(x = oil)) + geom_density() + geom_rug()
```


**Challenge:** Interact oil with oecd and plot. What will the lines look like?

```{r}
model2 <- lm(regime1 ~ GDPcap + oil * oecd + year, data = rossdata)
summary(model2)
```

Now consider interact oil with `year`. How would you plot two continuous variables?

```{r}
model3 <- lm(regime1 ~ GDPcap + oecd + oil * year, data = rossdata)
summary(model3)
```

In order to interpret the interaction term graphically, we need to pick one variable to treat as continuous --- the x-axis --- and another for which we will choose specific values. 
Use `oil` as the x-axis, and some values of `year` at which to evaluate it.
For `year` we could use the min, max, and median.
```{r}

```

```{r}
pred3_newdata <- expand.grid(oecd = 0,
                             GDPcap = mean(rossdata$GDPcap),
                             year = c(1966, 1981, 1997),
                             oil = seq(0, 100, by = 10))
pred3 <- augment(model3, newdata = pred3_newdata)
```
Now, let's plot it,
```{r}
ggplot(pred3, aes(x = oil, y = .fitted,
                  ymin = .fitted - 2 * .se.fit,
                  ymax = .fitted + 2 * .se.fit,
                  colour = factor(year))) +
  geom_line() +
  scale_colour_discrete("year")
```

This could also be visualized with colour and contours
```{r}
pred3_newdata <- expand.grid(oecd = 0,
                             GDPcap = mean(rossdata$GDPcap),
                             year = unique(rossdata$year),
                             oil = seq(0, 100, by = 1))
pred3 <- augment(model3, newdata = pred3_newdata)
ggplot(pred3, aes(x = oil, y = year,
                  fill = .fitted,
                  z = .fitted)) +
  geom_tile() +
  geom_contour(colour = "black") +
  scale_colour_discrete("year")
```

**Challenge** Interact `GDPpc` with oil and visualize the interactions.

## First Differences

A common way of comparing a 

# Robust standard errors

```{r}

```


# Residuals

Take the first model




## Writing to a file

You can use the function `write.csv` to save data to a csv file.

Try it!

You can use the function `save` to a save R objects to a native R file format.
Save these to files ending in `.RData`. 
You can then load the objects back into your workspace using `load()`.
tor reproducibility and transparancy it is better to save your data in language agnostic file formats, such as csvs, rather than language specific formats like `.RData` (R) or `.dta` (Stata).

## A quick introduction to functions

This is an example of a really stupid R function that adds two to each variable.
```{r}
add2 <- function(x) {
  x + 2
}
```
Try it ...

Functions are a way of encapsulating and reusing code. 
It takes a set of inputs (arguments), does some computation in its body, and then 
returns the result.

A *slightly* more realistic function is one that calculates the difference between the min and maximum value of a vector, i.e. the range: 
```{r}
diff_min_max <- function(x) {
  max(x) - min(x)
}
```
IRL, you would you the `range` function, but this is for pedagogy.

1. Write a function that calculates the difference between the 97.5 and 2.5 percentiles.
2. Now add a parameter that lets you set the values of the quantiles to use in the difference. This means that instead of 97.5 and 2.5, you can use any values.

For more on writing functions see: <http://www.ats.ucla.edu/stat/r/library/intro_function.htm>

<!-- Next time, create a function to encapsulate a plot type -->


## Sources

- Oil data from : 
- <http://staff.washington.edu/csjohns/503/lab5.r>
- <http://staff.washington.edu/csjohns/503/lab6.r>
